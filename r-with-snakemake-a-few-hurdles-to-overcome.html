<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
	<head>
		<link href="http://gmpg.org/xfn/11" rel="profile">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta http-equiv="content-type" content="text/html; charset=utf-8">

		<!-- Metadata -->
	<meta name="description" content="">
	<meta property="og:description" content="">
	<meta property="og:title" content="R with Snakemake: a few hurdles to overcome" />
	<meta property="og:type" content="article" />
	<meta property="og:url" content="https://cpauvert.github.io/r-with-snakemake-a-few-hurdles-to-overcome.html" />
		<meta property="og:image" content="https://cpauvert.github.io/images/profile.jpg" />

		<!-- Enable responsiveness on mobile devices-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

		<title>Charlie Pauvert webpages</title>

		<!-- CSS -->

		<link rel="stylesheet" href="https://cpauvert.github.io/theme/css/poole.css" />
		<link rel="stylesheet" href="https://cpauvert.github.io/theme/css/hyde.css" />
		<link rel="stylesheet" href="https://cpauvert.github.io/theme/css/syntax.css" />
			<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css" crossorigin="anonymous">
			<link rel="stylesheet" href="https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css">

		<!-- Feeds -->
<link href="https://cpauvert.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Charlie Pauvert webpages Full Atom Feed" />
<link href="https://cpauvert.github.io/feeds/snakemake.atom.xml" type="application/atom+xml" rel="alternate" title="Charlie Pauvert webpages Categories Atom Feed" />

		<!-- Analytics -->
	</head>

	<body class="theme-base-0b layout-reverse">
<div class="sidebar">
	<div class="container sidebar-sticky">
		<div class="sidebar-about">

			<h1>
				<a href="/">
					<!-- <img class="profile-picture" src="https://cpauvert.github.io/images/profile.jpg"> -->
					Charlie Pauvert webpages
				</a>
			</h1>
			<p class="lead"></p>
			<p class="lead"> </p>
			<p></p>
		</div>
			<ul class="sidebar-nav">
					<li><a href="https://cpauvert.github.io/pages/about.html">About</a></li>
			</ul>
		<nav class="sidebar-social">
					<a class="sidebar-social-item" href="https://www.researchgate.net/profile/Charlie_Pauvert" target="_blank">
						<i class="ai ai-researchgate"></i>
					</a>
					<a class="sidebar-social-item" href="https://www.linkedin.com/in/charliepauvert" target="_blank">
						<i class="fa fa-linkedin"></i>
					</a>
					<a class="sidebar-social-item" href="https://github.com/cpauvert" target="_blank">
						<i class="fa fa-github"></i>
					</a>
			<a class="sidebar-social-item" href="https://cpauvert.github.io/feeds/all.atom.xml">
				<i class="fa fa-rss"></i>
			</a>
		</nav>
			<p class="sidebar-footer">(c) Copyright Charlie Pauvert 2020</p>
	</div>
</div>		<div class="content container">
<div class="post">
	<h1 class="post-title">R with Snakemake: a few hurdles to overcome</h1>
	<span class="post-date">mer. 21 octobre 2020</span>
	<p>When working on the <a href="https://cpauvert.github.io/legolize-dada2.html">wrappers for DADA2</a>, I had to respect both the grammar of Python/Snakemake and R. Here are some of the hurdles I have encountered.</p>
<h2>Keeping the log</h2>
<p>Keeping track of the log is quite easy in Snakemake when the tools can run in the shell. Don&rsquo;t mistake me, R scripts can also be run on the shell using <code>Rscript</code> and <a href="https://lachlandeer.github.io/snakemake-econ-r-tutorial/logging-output-and-errors.html">Deer and Langer</a> showed that you can use the command <code>Rscript &gt; {log}</code> to correctly keep track of your script. However, when using wrappers you do not have access to this command because in the <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/writing_snakefiles.html#grammar">Snakemake grammar</a> instead of the <code>script:</code> word you have the <code>wrapper:</code> word.</p>
<p>I knew the <code>sink()</code> R function to redirect the output of R commands to a file. But when trying to redirect both messages and errors to the file when testing my wrappers it failed. The following <a href="https://stackoverflow.com/a/48173272">post</a> on stackoverflow provided the solution, which in short needs two invocations of <code>sink()</code> to be able to capture both messages. It is now included in the wrappers I wrote.</p>
<h2>Passing parameters to R</h2>
<p>Snakemake provide both reproducible and customizable workflows. But providing parameters to R wrappers was harder than I thought. Looking at others R wrappers I saw two approaches. Either be fully explicit (and redundant) by copying all the R arguments of the needed functions into the Snakemake <code>params:</code> word. Or be transparent and pass arguments in a character string that would be further interpreted with the R functions <code>parse()</code> and <code>eval()</code>.</p>
<p>I wanted something more flexible and decided to rely on the R function <code>do.call()</code> which enables the execution of a function based on arguments provided as named list (see 6.2.4 from <a href="https://adv-r.hadley.nz/functions.html#function-fundamentals">Hadley&rsquo;s Advanced R</a>).</p>
<p>Using such structure, I could pass a Python dictionary to Snakemake <code>params:</code> that would then be interpreted as a named lists in R. For instance:</p>
<div class="highlight"><pre><span></span><code><span class="n">rule</span> <span class="n">dada2_filter_trim_pe</span><span class="p">:</span>
    <span class="c1"># [...]</span>
    <span class="n">params</span><span class="p">:</span>
        <span class="p">{</span><span class="s1">&#39;maxEE&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;truncLen&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">240</span><span class="p">,</span><span class="mi">200</span><span class="p">]</span> <span class="p">}</span>
    <span class="c1"># [...]</span>
</code></pre></div>

<p>Snakemake convert the Python dictionary into a named list which can be directly used for the R function (here <code>dada2::filterAndTrim()</code>). Such named list if part of the larger <code>snakemake</code> S4 object that we can access in R (more info on <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#external-scripts">Snakemake docs</a>). </p>
<p>However, you cannot concatenate the lists provided (<code>snakemake@input</code>, <code>snakemake@output</code> and <code>snakemake@params</code>) and expect <code>do.call()</code> to do all the work. No, because Snakemake passes the <code>input:</code> as unnumbered list <strong>and</strong> as named list. So for input and output slots I could not do directly <code>do.call(filterAndTrim, snakemake@input)</code>. Instead, I needed to prepare the arguments as follow:</p>
<div class="highlight"><pre><span></span><code><span class="n">args</span><span class="o">&lt;-</span><span class="nf">list</span><span class="p">(</span>
        <span class="n">fwd</span> <span class="o">=</span> <span class="n">snakemake</span><span class="o">@</span><span class="n">input</span><span class="p">[[</span><span class="s">&quot;fwd&quot;</span><span class="p">]],</span>
        <span class="n">rev</span> <span class="o">=</span> <span class="n">snakemake</span><span class="o">@</span><span class="n">input</span><span class="p">[[</span><span class="s">&quot;rev&quot;</span><span class="p">]],</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">snakemake</span><span class="o">@</span><span class="n">output</span><span class="p">[[</span><span class="s">&quot;filt&quot;</span><span class="p">]],</span>
        <span class="n">filt.rev</span> <span class="o">=</span> <span class="n">snakemake</span><span class="o">@</span><span class="n">output</span><span class="p">[[</span><span class="s">&quot;filt_rev&quot;</span><span class="p">]],</span>
        <span class="n">multithread</span><span class="o">=</span><span class="n">snakemake</span><span class="o">@</span><span class="n">threads</span>
<span class="p">)</span>
</code></pre></div>

<p>Most of the submitted Snakemake wrappers can now accept Python dictionaries to customize the underlying DADA2 R functions.</p>
<p>These wrappers are currently under reviews by the team of the Snakemake wrappers repository. Meanwhile I try to design a DADA2 meta-wrapper to be able to nicely assemble these <em>bricks</em>.</p>
</div>
		</div>
	</body>
</html>